{% extends 'public/base_cpanel.html' %}

{% block title %}Crud - Python 游냀 | Gr치ficas{% endblock %}

{% block body %}
<div class="container mt-5">
  <h2 class="text-center mb-5">Gr치fica de Roles</h2>

  <!-- Gr치fica de Roles -->
  <div class="row mb-4">
    <div class="col-md-8 offset-md-2">
      <div class="card">
        <div class="card-header text-center">
          
          <h5>Distribuci칩n de Roles</h5>
        </div>
        <div class="card-body">
          <canvas id="graficaRoles"></canvas>
        </div>
      </div>
    </div>
  </div>

  <h2 class="text-center mb-5">Gr치fica de 츼reas</h2>

  <!-- Gr치fica de 츼reas -->
  <div class="row mb-4">
    <div class="col-md-8 offset-md-2">
      <div class="card">
        <div class="card-header text-center">
          <h5>Distribuci칩n de Personas por 츼rea</h5>
        </div>
        <div class="card-body">
          <canvas id="graficaAreas"></canvas>
        </div>
      </div>
    </div>
  </div>

  <h2 class="text-center mb-5">Gr치fica de Accesos por Fecha</h2>

  <!-- Formulario para seleccionar fechas -->
  <div class="row mb-4">
    <div class="col-md-8 offset-md-2">
      <form id="formFechas">
        <div class="row">
          <div class="col-md-5">
            <label for="fechaInicio" class="form-label">Fecha Inicio</label>
            <input type="date" id="fechaInicio" class="form-control" required>
          </div>
          <div class="col-md-5">
            <label for="fechaFin" class="form-label">Fecha Fin</label>
            <input type="date" id="fechaFin" class="form-control" required>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Filtrar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Gr치fica de Accesos -->
  <div class="row mb-4">
    <div class="col-md-8 offset-md-2">
      <div class="card">
        <div class="card-header text-center">
          <h5>Distribuci칩n de Accesos por Clave</h5>
        </div>
        <div class="card-body">
          <canvas id="graficaAccesos"></canvas>
        </div>
      </div>
    </div>
  </div>

  <h2 class="text-center mb-5">Gr치fica de Fechas de Inicio de Sesi칩n por Usuario</h2>

  <!-- Formulario para seleccionar el nombre del usuario -->
  <div class="row mb-4">
    <div class="col-md-8 offset-md-2">
      <form id="formUsuario">
        <div class="row">
          <div class="col-md-10">
            <label for="nombreUsuario" class="form-label">Nombre del Usuario</label>
            <select id="nombreUsuario" class="form-select" required>
              <option value="" disabled selected>Seleccione un usuario</option>
            </select>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Filtrar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Gr치fica de Fechas por Usuario -->
  <div class="row mb-4">
    <div class="col-md-8 offset-md-2">
      <div class="card">
        <div class="card-header text-center">
          <h5>Fechas de Inicio de Sesi칩n por Usuario</h5>
        </div>
        <div class="card-body">
          <canvas id="graficaFechasUsuario"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Carga de Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // Funci칩n para generar colores 칰nicos y din치micos
  function generarColoresUnicos(cantidad) {
    const colores = [];
    for (let i = 0; i < cantidad; i++) {
      const r = Math.floor(Math.random() * 255);
      const g = Math.floor(Math.random() * 255);
      const b = Math.floor(Math.random() * 255);
      colores.push(`rgba(${r}, ${g}, ${b}, 0.5)`); // Color con transparencia
    }
    return colores;
  }

function cargarGraficaRoles() {
  fetch("{{ url_for('grafica_roles_datos') }}")
    .then(response => response.json())
    .then(data => {
      if (data.nombres) {
        const ctx = document.getElementById('graficaRoles').getContext('2d');
        const colores = generarColoresBonitos(data.nombres.length);

        // Limpiar gr치fica previa (si existe)
        if (window.miGraficaRoles) {
          window.miGraficaRoles.destroy();
        }

        window.miGraficaRoles = new Chart(ctx, {
          type: 'doughnut', // Donut para simular 3D
          data: {
            labels: data.nombres,
            datasets: [{
              label: 'Distribuci칩n de Roles',
              data: Array(data.nombres.length).fill(1),
              backgroundColor: colores,
              borderColor: 'rgba(0,0,0,0.2)',
              borderWidth: 2,
              hoverOffset: 10, // Efecto hover m치s sutil
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false, // Permite controlar tama침o con CSS
            cutout: '40%', // Hace el centro m치s grande
            plugins: {
              legend: { position: 'bottom' },
              title: { display: true, text: 'Distribuci칩n de Roles', font: { size: 16, weight: 'bold' } }
            },
            animation: {
              animateRotate: true,
              animateScale: true
            }
          },
          plugins: [{
            id: 'sombra3d',
            afterDatasetDraw(chart) {
              const ctx = chart.ctx;
              const meta = chart.getDatasetMeta(0);
              meta.data.forEach(slice => {
                ctx.save();
                ctx.shadowColor = 'rgba(0,0,0,0.3)';
                ctx.shadowBlur = 8;
                ctx.shadowOffsetX = 4;
                ctx.shadowOffsetY = 4;
                ctx.fill();
                ctx.restore();
              });
            }
          }]
        });
      }
    })
    .catch(error => console.error('Error al cargar los datos:', error));
}

// Funci칩n para generar colores
function generarColoresBonitos(cantidad) {
  const baseColores = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
  return Array.from({ length: cantidad }, (_, i) => baseColores[i % baseColores.length]);
}

// Variable para definir el tipo de gr치fico
const tipoGrafico = 'line'; // Cambia aqu칤: 'bar', 'line', 'pie', 'doughnut', etc.

function cargarGraficaAreas() {
  fetch("{{ url_for('grafica_areas_datos') }}")
    .then(response => response.json())
    .then(data => {
      if (data.nombres && data.cantidades) {
        const canvas = document.getElementById('graficaAreas');
        if (!canvas) {
          console.error('No se encontr칩 el canvas con id "graficaAreas"');
          return;
        }

        const ctx = canvas.getContext('2d');

        // Si ya existe una gr치fica previa, destruyela antes de crear una nueva
        if (window.graficaAreasInstance) {
          window.graficaAreasInstance.destroy();
        }

        // Generar colores o usar una paleta predeterminada
        const colores = generarColoresUnicos(data.nombres.length);

        // Definir configuraci칩n b치sica
        let opcionesGrafico = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true },
            title: { 
              display: true, 
              text: 'Distribuci칩n de Personas por 츼rea',
              font: { size: 18 }
            }
          },
          animation: {
            duration: 1000,
            easing: 'easeOutBounce'
          }
        };

        // Si es un gr치fico de barras o l칤neas, agregar escalas
        if (tipoGrafico === 'bar' || tipoGrafico === 'line') {
          opcionesGrafico.scales = {
            y: { 
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          };
        }

        // Configurar el gr치fico
        window.graficaAreasInstance = new Chart(ctx, {
          type: tipoGrafico,
          data: {
            labels: data.nombres,
            datasets: [{
              label: 'N칰mero de Personas',
              data: data.cantidades,
              backgroundColor: (tipoGrafico === 'line') ? 'rgba(54, 162, 235, 0.3)' : colores,
              borderColor: colores.map(color => color.replace('0.7', '1')),
              borderWidth: 1,
              borderRadius: (tipoGrafico === 'bar') ? 8 : 0, // Bordes solo en barras
              fill: (tipoGrafico === 'line') ? true : false
            }]
          },
          options: opcionesGrafico
        });
      }
    })
    .catch(error => console.error('Error al cargar los datos:', error));
}

// Definici칩n de la funci칩n de colores
function generarColoresUnicos(cantidad) {
  const coloresBase = [
    'rgba(255, 99, 132, 0.7)',
    'rgba(54, 162, 235, 0.7)',
    'rgba(255, 206, 86, 0.7)',
    'rgba(75, 192, 192, 0.7)',
    'rgba(153, 102, 255, 0.7)',
    'rgba(255, 159, 64, 0.7)',
    'rgba(199, 199, 199, 0.7)',
    'rgba(255, 205, 86, 0.7)'
  ];
  let colores = [];
  for (let i = 0; i < cantidad; i++) {
    colores.push(coloresBase[i % coloresBase.length]);
  }
  return colores;
}


  // Funci칩n para llenar el select con los nombres de los usuarios
  function cargarNombresUsuarios() {
    fetch("{{ url_for('obtener_nombres_usuarios') }}")
      .then(response => response.json())
      .then(data => {
        const select = document.getElementById('nombreUsuario');
        if (data.nombres) {
          data.nombres.forEach(nombre => {
            const option = document.createElement('option');
            option.value = nombre;
            option.textContent = nombre;
            select.appendChild(option);
          });
        }
      })
      .catch(error => console.error('Error al cargar los nombres de los usuarios:', error));
  }

  // Funci칩n para cargar la gr치fica de fechas por usuario
  function cargarGraficaFechasUsuario(nombreUsuario) {
    fetch(`{{ url_for('grafica_fechas_usuario_datos') }}?nombre_usuario=${nombreUsuario}`)
      .then(response => response.json())
      .then(data => {
        if (data.fechas) {
          const ctx = document.getElementById('graficaFechasUsuario').getContext('2d');
          const colores = generarColoresUnicos(data.fechas.length);

          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: data.fechas,
              datasets: [{
                label: 'Fechas de Inicio de Sesi칩n',
                data: Array(data.fechas.length).fill(1),
                backgroundColor: colores,
                borderColor: colores.map(color => color.replace('0.5', '1')),
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
                title: { display: true, text: `Fechas de Inicio de Sesi칩n de ${nombreUsuario}` }
              },
              scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } }
              }
            }
          });
        }
      })
      .catch(error => console.error('Error al cargar los datos:', error));
  }

  // Manejar el env칤o del formulario de fechas
  document.getElementById('formFechas').addEventListener('submit', function (e) {
    e.preventDefault();
    const fechaInicio = document.getElementById('fechaInicio').value;
    const fechaFin = document.getElementById('fechaFin').value;

    if (fechaInicio && fechaFin) {
      cargarGraficaAccesos(fechaInicio, fechaFin);
    }
  });

  // Manejar el env칤o del formulario de usuarios
  document.getElementById('formUsuario').addEventListener('submit', function (e) {
    e.preventDefault();
    const nombreUsuario = document.getElementById('nombreUsuario').value;

    if (nombreUsuario) {
      cargarGraficaFechasUsuario(nombreUsuario);
    }
  });

  // Cargar las gr치ficas y nombres de usuarios al cargar la p치gina
  document.addEventListener('DOMContentLoaded', () => {
    cargarGraficaRoles();
    cargarGraficaAreas();
    cargarNombresUsuarios();
  });
</script>
{% endblock %}